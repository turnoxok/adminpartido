<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
 

<!-- Título y descripción -->
<title>Tilcara Legends | Fijación de precios</title>
<meta name="description" content="encuentro de rugby de veteranos.">

<!-- Icono para pestañas / navegador -->
<link rel="icon" type="image/png" href="https://i.ibb.co/nN8LPTjD/logo-verde.png" />

<!-- Color de la barra del navegador (Chrome / Edge móvil) -->
<meta name="theme-color" content="#084D1F">

<!-- Open Graph (WhatsApp / Facebook / LinkedIn) -->
<meta property="og:title" content="Tilcara Legends | Fijación de precios">
<meta property="og:description" content="Encuentro de rugby de veteranos.">
<meta property="og:image" content="https://i.ibb.co/nN8LPTjD/logo-verde.png">
<meta property="og:url" content="https://tilcaralegends.netlify.app/">
<meta property="og:type" content="website">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Tilcara Legends | Fijación de precios">
<meta name="twitter:description" content="Encuentro de rugby de veteranos.">
<meta name="twitter:image" content="https://tilcaralegends.netlify.app/">

  
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<style>
/* ===== Reset y base ===== */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: "Montserrat", sans-serif;
  background-color: #F5F6F2;
  color: #084D1F;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  overflow-x: hidden;
  padding: 0 10px;
}

/* ===== Tipografía ===== */
h1, h2, h3, h4 {
  text-align: center;
  margin: 5px 0;
}

/* ===== Portada ===== */
.portada {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  margin: 0 auto;
  padding: 10px 0;
}

.portada img {
  max-width: 100%;
  width: auto;
  height: auto;
  display: block;
  border-radius: 0 0 12px 12px;
}

/* ===== Login ===== */
#login {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  max-width: 400px;
  margin: 20px auto;
  padding: 20px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
}

#login input, #login button {
  width: 100%;
  margin: 5px 0;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #084D1F;
  font-size: 16px;
}

#login button {
  background: #084D1F;
  color: #F5F6F2;
  cursor: pointer;
  transition: background 0.2s;
}

#login button:hover {
  background: #0A702A;
}

/* ===== Menús ===== */
.menu {
  background: #F5F6F2;
  padding: 12px;
  margin: 15px 0;
  border-radius: 8px;
  border: 2px solid #084D1F;
  box-shadow: 2px 2px 5px rgba(0,0,0,0.15);
  width: 100%;
  max-width: 500px;
}

ul {
  list-style: none;
  padding-left: 0;
}

li {
  padding: 6px 0;
  line-height: 1.4;
}

input[type=checkbox] {
  margin-right: 5px;
}

.form-agregar {
  text-align: center;
  margin: 10px 0;
}

.deshabilitado {
  background: #eee;
  color: #999;
}

/* ===== Inputs y botones global ===== */
input, button {
  font-family: "Montserrat", sans-serif;
  padding: 8px;
  margin: 5px;
  border-radius: 6px;
  border: 1px solid #084D1F;
  font-size: 16px;
}

button {
  background: #084D1F;
  color: #F5F6F2;
  cursor: pointer;
  transition: background 0.2s ease-in-out;
}

button:hover {
  background: #0A702A;
}

/* ===== App container ===== */
#app {
  display: none;
  width: 100%;
  max-width: 600px;
  margin: 0 auto;
}

/* ===== Responsive Móvil ===== */
@media (max-width: 600px) {
  input, button {
    width: 100%;
    max-width: 100%;
    font-size: 14px;
  }

  .menu {
    padding: 10px;
    margin: 10px 0;
  }

  li {
    font-size: 14px;
  }

  #login {
    padding: 15px;
  }

  .portada {
    padding: 5px 0;
  }
}

/* ===== Escritorio ===== */
@media (min-width: 601px) {
  body {
    padding: 0 20px;
  }

  .menu {
    max-width: 600px;
  }

  input, button {
    font-size: 16px;
  }
}
/* ===== LOADER ===== */
#loader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #084D1F;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 9999;
}

#loader img {
  width: 120px;
  height: auto;
  animation: pulse 1.5s infinite ease-in-out;
}

#loader p {
  color: #F5F6F2;
  margin-top: 20px;
  font-size: 1.2rem;
  font-weight: 600;
  letter-spacing: 1px;
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.15); opacity: 0.8; }
  100% { transform: scale(1); opacity: 1; }
}

.hidden {
  display: none !important;
}

</style>
</head>
<body>
<!-- LOADER -->
<div id="loader">
  <img src="https://i.ibb.co/GfJfM48J/Tilcara-logo-con-sombra.png" alt="Escudo del Club">
  
</div>
<!-- Portada -->
  <div class="portada">
    <img src="https://i.ibb.co/jvFxXN4M/Tilcara-portada-precios.png" alt="Encuentro Rugby Veteranos">
  </div>
<div id="login">
<h2>Login</h2>
<input id="user" placeholder="Usuario">
<input id="pass" type="password" placeholder="Clave">
<button onclick="login()">Entrar</button>
</div>

<div id="app">
<h2>Bienvenido <span id="rolText"></span></h2>

<div id="formAgregarMenu" class="form-agregar" style="display:none;">
<h3>Fijación de precios x 150 Personas</h3>
<input id="nuevoMenu" placeholder="Item a Disputar">
<button onclick="agregarMenu()">Crear</button>
</div>

<div id="menuContainer"></div>
</div>
<script>
const URL_PROXY = "/.netlify/functions/proxy";
let rol=null, usuarioActual=null, claveActual=null;
let estadoItems = {};   // para guardar localmente estados de cada item

const loader = document.getElementById("loader");

// Funciones para mostrar y ocultar loader
function showLoader() { loader.classList.remove("hidden"); }
function hideLoader() { loader.classList.add("hidden"); }

// Mostrar loader al inicio mientras carga la portada
window.addEventListener("load", () => {
  showLoader();
  setTimeout(() => hideLoader(), 1200); // se oculta después de 1.2s
});

// LOGIN
async function login(){
  showLoader();
  usuarioActual=document.getElementById("user").value;
  claveActual=document.getElementById("pass").value;
  try{
    const res = await fetch(URL_PROXY,{
      method:"POST",
      body: JSON.stringify({action:"login",usuario:usuarioActual,clave:claveActual})
    });
    const data = await res.json();
    hideLoader();
    if(data.status==="ok"){
      rol=data.rol;
      document.getElementById("rolText").innerText = usuarioActual;
      document.getElementById("login").style.display="none";
      document.getElementById("app").style.display="block";
      if(rol==="Dirigente")document.getElementById("formAgregarMenu").style.display="block";
      cargarMenu();
    }else alert(data.msg);
  }catch(err){ hideLoader(); alert("Error de conexión"); console.error(err);}
}

// CARGAR MENUS
async function cargarMenu(){
  showLoader();
  try{
    const res = await fetch(URL_PROXY+"?hoja=Menu");
    const data = await res.json();
    const menus = {};
    data.forEach(r=>{ 
      if(!menus[r.NombreMenu]) menus[r.NombreMenu]=[]; 
      menus[r.NombreMenu].push(r); 
    });

    let html="";
    Object.keys(menus).forEach(menu=>{
      let totalMenu=0;
      html+=`<div class="menu"><h3>${menu}</h3><ul>`;

      menus[menu].forEach(item=>{
        if(!item.Proveedor || !item.Descripcion) return; // ignora filas vacías

        const votos = item.Voto || 0;
        const nombres = item.NombreDelVotante || "";
        const votoUsuario = item.NombreDelVotante ? item.NombreDelVotante.split(",").includes(usuarioActual) : false;

        const estado = item.Estado || "sin Desición";
        let color="";
        if(estado==="gana") color="lightgreen";
        else if(estado==="pierde") color="lightcoral";

        html+=`<li style="background:${color}; padding:5px; margin:3px 0;">
          <input type="checkbox" ${votoUsuario ? 'checked' : ''} ${rol !== "Dirigente" ? "disabled" : ""}
            onchange="actualizarSeleccion('${menu}','${item.Proveedor}','${item.Descripcion}',this.checked)">
          ${item.Proveedor} - ${item.Descripcion} - $${item.Precio} - Votos: ${votos} (${nombres})
          ${rol==="Dirigente" ? `<button onclick="cambiarEstado('${menu}','${item.Proveedor}','${item.Descripcion}','${estado}')">${estado}</button>` : ''}
        </li>`;

        if(estado === "gana") totalMenu += Number(item.Precio || 0);
      });

      html+="</ul>";
      html+=`<h4>Total: $<span id="total_${menu}">${totalMenu}</span></h4>`;

      if(rol==="Dirigente"){
        html+=`<div class="form-agregar">
          <input id="prov_${menu}" placeholder="Proveedor">
          <input id="desc_${menu}" placeholder="Descripción">
          <input id="precio_${menu}" type="number" placeholder="Precio">
          <button onclick="agregarItem('${menu}')">Agregar Item</button>
        </div>`;
      }
      
      html+="</div>";
    });

    document.getElementById("menuContainer").innerHTML=html;
  }catch(err){ 
    console.error(err); 
    alert("Error cargando menús"); 
  } finally {
    hideLoader();
  }
}

// CREAR MENU
function agregarMenu(){
  const nombreMenu=document.getElementById("nuevoMenu").value.trim();
  if(!nombreMenu){alert("Ingrese nombre del menú");return;}
  showLoader();
  fetch(URL_PROXY,{
    method:"POST",
    body: JSON.stringify({usuario:usuarioActual,clave:claveActual,action:"agregarMenu",NombreMenu:nombreMenu})
  }).then(r=>r.json()).then(r=>{
    if(r.status==="ok"){document.getElementById("nuevoMenu").value="";cargarMenu();}
    else alert(r.msg);
  }).finally(()=> hideLoader());
}

// AGREGAR ITEM
function agregarItem(menu){
  const prov=document.getElementById(`prov_${menu}`).value.trim();
  const desc=document.getElementById(`desc_${menu}`).value.trim();
  const precio=Number(document.getElementById(`precio_${menu}`).value.trim());
  if(!prov||!desc||isNaN(precio)){alert("Complete todos los campos");return;}
  showLoader();
  fetch(URL_PROXY,{
    method:"POST",
    body: JSON.stringify({usuario:usuarioActual,clave:claveActual,action:"agregarItem",NombreMenu:menu,Proveedor:prov,Descripcion:desc,Precio:precio})
  }).then(r=>r.json()).then(r=>{
    if(r.status==="ok"){
      document.getElementById(`prov_${menu}`).value="";
      document.getElementById(`desc_${menu}`).value="";
      document.getElementById(`precio_${menu}`).value="";
      cargarMenu();
    } else alert(r.msg);
  }).finally(()=> hideLoader());
}

// SELECCIONAR / DESHABILITAR ITEM
function actualizarSeleccion(menu,prov,desc,checked){
  showLoader();
  fetch(URL_PROXY,{
    method:"POST",
    body: JSON.stringify({usuario:usuarioActual,clave:claveActual,action:"seleccionar",NombreMenu:menu,Proveedor:prov,Descripcion:desc,Seleccionado:checked})
  }).then(r=>r.json()).then(r=>cargarMenu()).finally(()=> hideLoader());
}

// CAMBIAR ESTADO (gana/pierde/sin)
function cambiarEstado(menu,prov,desc,estadoActual){
  let nuevoEstado = "sin";
  if(estadoActual==="sin") nuevoEstado="gana";
  else if(estadoActual==="gana") nuevoEstado="pierde";
  else if(estadoActual==="pierde") nuevoEstado="sin";

  showLoader();
  fetch(URL_PROXY,{
    method:"POST",
    body: JSON.stringify({
      usuario:usuarioActual,
      clave:claveActual,
      action:"cambiarEstado",
      NombreMenu:menu,
      Proveedor:prov,
      Descripcion:desc,
      Estado:nuevoEstado
    })
  }).then(r=>r.json()).then(r=>{
    if(r.status==="ok") cargarMenu();
    else alert(r.msg);
  }).finally(()=> hideLoader());
}

// CALCULAR TOTAL
function calcularTotal(menu){
  const lis=document.querySelectorAll(`.menu`);
  lis.forEach(li=>{
    if(li.querySelector("h3").innerText===menu){
      let total=0;
      li.querySelectorAll("ul li").forEach(item=>{
        if(item.style.background==="lightgreen"){ // solo suma los que GANAN
          const precio=item.innerText.split('- $')[1].split(' - ')[0];
          total+=Number(precio);
        }
      });
      li.querySelector(`#total_${menu}`).innerText=total;
    }
  });
}
</script>


  <script>
  // ...todas tus funciones existentes...

  // ===== POLLING PARA ACTUALIZAR MENÚ EN TIEMPO REAL =====
  let menuCache = {}; // guarda el último estado de cada item

  async function actualizarMenuRealtime() {
    try {
      const res = await fetch(URL_PROXY + "?hoja=Menu");
      const data = await res.json();

      const nuevaCache = {};
      data.forEach(item => {
        const key = `${item.NombreMenu}|${item.Proveedor}|${item.Descripcion}`;
        nuevaCache[key] = {
          Voto: item.Voto,
          Estado: item.Estado,
          NombreDelVotante: item.NombreDelVotante
        };
      });

      let hayCambios = false;
      for (const key in nuevaCache) {
        if (!menuCache[key] ||
            menuCache[key].Voto !== nuevaCache[key].Voto ||
            menuCache[key].Estado !== nuevaCache[key].Estado ||
            menuCache[key].NombreDelVotante !== nuevaCache[key].NombreDelVotante) {
          hayCambios = true;
          break;
        }
      }

      if (hayCambios) {
        cargarMenu();
        menuCache = nuevaCache;
      }

    } catch (err) {
      console.error("Error en polling:", err);
    }
  }

  // iniciar polling cada 3 segundos
  setInterval(actualizarMenuRealtime, 3000);
</script>

</body>
</html>
